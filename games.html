<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>games</title>
<link rel="icon" href="bcps.png?v=1">

<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
/* styles unchanged */
</style>
</head>
<body>

<a href="index.html">back</a>
<input id="search" class="search" placeholder="search games">
<div id="content"></div>

<script>
let fav = JSON.parse(localStorage.favorites || "[]");
let recent = JSON.parse(localStorage.recent || "[]");
let all = [];

function save(){
  localStorage.favorites = JSON.stringify(fav);
  localStorage.recent = JSON.stringify(recent);
}

function openGame(g){
  recent = [g.title, ...recent.filter(t => t !== g.title)].slice(0,8);
  save();
  window.open(g.link, "_blank");
}

function toggleFav(t){
  fav.includes(t) ? fav = fav.filter(x => x !== t) : fav.push(t);
  save();
  render();
}

function section(name, games){
  if(!games.length) return "";
  return `
    <h2>${name}</h2>
    <div class="grid">
      ${games.map(g => `
        <div class="game" onclick='openGame(${JSON.stringify(g)})'>
          <div class="star" onclick="event.stopPropagation();toggleFav('${g.title}')">
            ${fav.includes(g.title) ? "★" : "☆"}
          </div>
          <img src="${g.imgSrc}">
          <div>${g.title}</div>
        </div>
      `).join("")}
    </div>
  `;
}

function render(){
  const q = search.value.toLowerCase();
  const enabled = all.filter(g => g.enabled && g.title.toLowerCase().includes(q));
  const byTag = {};

  enabled.forEach(g => g.tags.forEach(t => (byTag[t] = byTag[t] || []).push(g)));

  content.innerHTML =
    section("favorites", enabled.filter(g => fav.includes(g.title))) +
    section("recently played", recent.map(t => enabled.find(g => g.title === t)).filter(Boolean)) +
    Object.keys(byTag).sort().map(t => section(t, byTag[t])).join("");
}

/* ONLY CHANGE HERE */
fetch("games.json")
  .then(r => r.json())
  .then(d => { all = d; render(); });

search.oninput = render;

document.addEventListener("keydown", e => {
  if (localStorage.panicEnabled === "false") return;

  const key = localStorage.panicKey || "Escape";
  let url = localStorage.panicUrl || "https://bcps.schoology.com/home";

  if (e.key === key) {
    if (!url.startsWith("http")) url = "https://" + url;
    location.href = url;
  }
});
</script>

</body>
</html>
